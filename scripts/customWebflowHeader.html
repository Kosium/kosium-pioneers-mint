<script src="https://cdn.jsdelivr.net/gh/ethereum/web3.js@1.0.0-beta.36/dist/web3.min.js" integrity="sha256-nWBTbvxhJgjslRyuAKJHK+XcZPlCnmIAAMixz6EefVk=" crossorigin="anonymous"></script>

<script type="text/javascript"> 
  let numToMint = 0;

  async function mintPioneer(){
    if (numToMint == 0){
      return;
    }
    
    console.log('TESTING FUNCTION CALL');
    console.log('mint this many: ', numToMint);
    
    const NFT_ABI = [
      {
      "inputs": [
        {
          "internalType": "uint256",
          "name": "numberOfTokens",
          "type": "uint256"
        }
      ],
      "name": "mintPresalePioneer",
      "outputs": [],
      "stateMutability": "payable",
      "type": "function"
    }
    ];
    
    
    
    if(typeof window.ethereum !== 'undefined') {
      console.log('using current provider. metamask is installed');
      var web3Instance = new Web3(window.ethereum);//window.web3.currentProvider
      
      await ethereum.request({ method: 'eth_requestAccounts' });
      // const addrs = await ethereum.request({ method: 'eth_accounts' });
      // console.log('ethereum get accounts', addrs);
      // let selectedAddr = ethereum.selectedAddress;
      
      // var block = await web3Instance.eth.getBlock("latest");
      // var gasLimit = block.gasLimit/block.transactions.length;
      let gasLimit = numToMint * 150000;
      const nftContract = new web3Instance.eth.Contract(
        NFT_ABI,
        '0x9C93F03D43A7F1B0384c97E7C47c2515E53bb2a5',
        { gasLimit: gasLimit}// toString(gasLimit) }
      );
      console.log('minting presale pioneer sending');
      //web3.eth.getTransactionCount(ethAddress) //can get txn count and increment for nonce
      let ethVal = 60000000000000000*numToMint;
      const result = await nftContract.methods
      .mintPresalePioneer(numToMint)
      .send({ from: ethereum.selectedAddress, value: ethVal });
      console.log('done minting');
      
    } else {
      console.log('metamask not installed');
    }
  }
  
  function mintMore(){
    if (numToMint == 2){
      return;
    }
    ++numToMint;
    updateNumToMintLabel();
  }
  
  function mintLess(){
    if (numToMint == 0){
      return;
    }
    --numToMint;
    updateNumToMintLabel();
  }
  
  function updateNumToMintLabel(){
  	document.getElementById("numToMintLabel").innerHTML = numToMint.toString();
  }

  async function updateNumMintedLabel(){
    if(typeof window.ethereum !== 'undefined') {
      var web3Instance = new Web3(window.ethereum);//window.web3.currentProvider
    }
    else {
      console.log('window.ethereum was undefined');
    }
    
    const NFT_ABI_MINTED = [
      {
        "inputs": [],
        "name": "numMinted",
        "outputs": [
          {
            "internalType": "uint256",
            "name": "",
            "type": "uint256"
          }
        ],
        "stateMutability": "view",
        "type": "function"
      },
    ];

    let gasLimit = 100000;
    const nftContract = new web3Instance.eth.Contract(
      NFT_ABI_MINTED,
      '0x9C93F03D43A7F1B0384c97E7C47c2515E53bb2a5',
      { gasLimit: gasLimit}// toString(gasLimit) }
    );
    const result6 = await nftContract.methods
      .numMinted
      .call().call();
    console.log("numMinted = " + result6);
  	document.getElementById("numPioneersMintedText").innerHTML = result6.toString();
  }

  updateNumMintedLabel();
</script>